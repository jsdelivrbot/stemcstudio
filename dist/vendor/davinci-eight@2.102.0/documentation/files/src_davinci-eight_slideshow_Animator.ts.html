<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/davinci-eight/slideshow/Animator.ts - davinci-eight</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../../assets/logo.png" title="davinci-eight"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.126.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AbstractMatrix.html">AbstractMatrix</a></li>
                                <li><a href="../classes/AnimatedMirror.html">AnimatedMirror</a></li>
                                <li><a href="../classes/ArrowGeometry.html">ArrowGeometry</a></li>
                                <li><a href="../classes/AttribLocation.html">AttribLocation</a></li>
                                <li><a href="../classes/AttribMetaInfo.html">AttribMetaInfo</a></li>
                                <li><a href="../classes/BarnGeometry.html">BarnGeometry</a></li>
                                <li><a href="../classes/BoxBuilder.html">BoxBuilder</a></li>
                                <li><a href="../classes/BoxMesh.html">BoxMesh</a></li>
                                <li><a href="../classes/Canvas3D.html">Canvas3D</a></li>
                                <li><a href="../classes/Cartesian1.html">Cartesian1</a></li>
                                <li><a href="../classes/Cartesian2.html">Cartesian2</a></li>
                                <li><a href="../classes/Cartesian3.html">Cartesian3</a></li>
                                <li><a href="../classes/Cartesian4.html">Cartesian4</a></li>
                                <li><a href="../classes/Color.html">Color</a></li>
                                <li><a href="../classes/ColorFacet.html">ColorFacet</a></li>
                                <li><a href="../classes/ColorRGB.html">ColorRGB</a></li>
                                <li><a href="../classes/Complex.html">Complex</a></li>
                                <li><a href="../classes/ContextAttributesLogger.html">ContextAttributesLogger</a></li>
                                <li><a href="../classes/ContextController.html">ContextController</a></li>
                                <li><a href="../classes/ContextRenderer.html">ContextRenderer</a></li>
                                <li><a href="../classes/createView.html">createView</a></li>
                                <li><a href="../classes/CuboidGeometry.html">CuboidGeometry</a></li>
                                <li><a href="../classes/CuboidMesh.html">CuboidMesh</a></li>
                                <li><a href="../classes/CylinderArgs.html">CylinderArgs</a></li>
                                <li><a href="../classes/CylinderGeometry.html">CylinderGeometry</a></li>
                                <li><a href="../classes/Dimensions.html">Dimensions</a></li>
                                <li><a href="../classes/DirectionalLight.html">DirectionalLight</a></li>
                                <li><a href="../classes/DodecahedronGeometry.html">DodecahedronGeometry</a></li>
                                <li><a href="../classes/Drawable.html">Drawable</a></li>
                                <li><a href="../classes/EIGHTLogger.html">EIGHTLogger</a></li>
                                <li><a href="../classes/ElementArray.html">ElementArray</a></li>
                                <li><a href="../classes/ElementBuffer.html">ElementBuffer</a></li>
                                <li><a href="../classes/EllipsoidMesh.html">EllipsoidMesh</a></li>
                                <li><a href="../classes/Euclidean1.html">Euclidean1</a></li>
                                <li><a href="../classes/Euclidean2.html">Euclidean2</a></li>
                                <li><a href="../classes/Euclidean3.html">Euclidean3</a></li>
                                <li><a href="../classes/EulerFacet.html">EulerFacet</a></li>
                                <li><a href="../classes/Face3.html">Face3</a></li>
                                <li><a href="../classes/Frustum.html">Frustum</a></li>
                                <li><a href="../classes/Geometry.html">Geometry</a></li>
                                <li><a href="../classes/GeometryAttribute.html">GeometryAttribute</a></li>
                                <li><a href="../classes/GeometryData.html">GeometryData</a></li>
                                <li><a href="../classes/GeometryElements.html">GeometryElements</a></li>
                                <li><a href="../classes/GeometryMeta.html">GeometryMeta</a></li>
                                <li><a href="../classes/HTMLScriptsMaterial.html">HTMLScriptsMaterial</a></li>
                                <li><a href="../classes/IAnimation.html">IAnimation</a></li>
                                <li><a href="../classes/IAnimationClock.html">IAnimationClock</a></li>
                                <li><a href="../classes/IBufferGeometry.html">IBufferGeometry</a></li>
                                <li><a href="../classes/IContextConsumer.html">IContextConsumer</a></li>
                                <li><a href="../classes/IContextMonitor.html">IContextMonitor</a></li>
                                <li><a href="../classes/IContextProvider.html">IContextProvider</a></li>
                                <li><a href="../classes/IcosahedronGeometry.html">IcosahedronGeometry</a></li>
                                <li><a href="../classes/IDrawable.html">IDrawable</a></li>
                                <li><a href="../classes/IDrawList.html">IDrawList</a></li>
                                <li><a href="../classes/IExchange.html">IExchange</a></li>
                                <li><a href="../classes/IFacet
                extends IUnknown.html">IFacet
                extends IUnknown</a></li>
                                <li><a href="../classes/IFacetVisitor.html">IFacetVisitor</a></li>
                                <li><a href="../classes/IMaterial.html">IMaterial</a></li>
                                <li><a href="../classes/IPrologCommand.html">IPrologCommand</a></li>
                                <li><a href="../classes/IProperties.html">IProperties</a></li>
                                <li><a href="../classes/ISlide.html">ISlide</a></li>
                                <li><a href="../classes/IUnknown.html">IUnknown</a></li>
                                <li><a href="../classes/IUnknownArray.html">IUnknownArray</a></li>
                                <li><a href="../classes/KleinBottleGeometry.html">KleinBottleGeometry</a></li>
                                <li><a href="../classes/Line3.html">Line3</a></li>
                                <li><a href="../classes/LinearElement&lt;I, M, S&gt;.html">LinearElement&lt;I, M, S&gt;</a></li>
                                <li><a href="../classes/LineMaterial.html">LineMaterial</a></li>
                                <li><a href="../classes/LocalizableMessage.html">LocalizableMessage</a></li>
                                <li><a href="../classes/Material.html">Material</a></li>
                                <li><a href="../classes/Matrix1.html">Matrix1</a></li>
                                <li><a href="../classes/Matrix2.html">Matrix2</a></li>
                                <li><a href="../classes/Matrix3.html">Matrix3</a></li>
                                <li><a href="../classes/Matrix4.html">Matrix4</a></li>
                                <li><a href="../classes/Matrix&lt;M&gt;.html">Matrix&lt;M&gt;</a></li>
                                <li><a href="../classes/MeshLambertMaterial.html">MeshLambertMaterial</a></li>
                                <li><a href="../classes/MeshMaterial.html">MeshMaterial</a></li>
                                <li><a href="../classes/ModelFacet.html">ModelFacet</a></li>
                                <li><a href="../classes/Mutable.html">Mutable</a></li>
                                <li><a href="../classes/NumberIUnknownMap&lt;V&gt;.html">NumberIUnknownMap&lt;V&gt;</a></li>
                                <li><a href="../classes/OcosahedronGeometry.html">OcosahedronGeometry</a></li>
                                <li><a href="../classes/OctahedronGeometry.html">OctahedronGeometry</a></li>
                                <li><a href="../classes/Perspective.html">Perspective</a></li>
                                <li><a href="../classes/PerspectiveCamera.html">PerspectiveCamera</a></li>
                                <li><a href="../classes/Point3.html">Point3</a></li>
                                <li><a href="../classes/PointMaterial.html">PointMaterial</a></li>
                                <li><a href="../classes/PolyhedronGeometry.html">PolyhedronGeometry</a></li>
                                <li><a href="../classes/Rational.html">Rational</a></li>
                                <li><a href="../classes/RevolutionGeometry.html">RevolutionGeometry</a></li>
                                <li><a href="../classes/Scene.html">Scene</a></li>
                                <li><a href="../classes/ShaderVariableDecl.html">ShaderVariableDecl</a></li>
                                <li><a href="../classes/Shareable.html">Shareable</a></li>
                                <li><a href="../classes/Simplex.html">Simplex</a></li>
                                <li><a href="../classes/Simplex1Geometry.html">Simplex1Geometry</a></li>
                                <li><a href="../classes/SmartMaterial.html">SmartMaterial</a></li>
                                <li><a href="../classes/SmartMaterialBuilder.html">SmartMaterialBuilder</a></li>
                                <li><a href="../classes/SphereGeometry.html">SphereGeometry</a></li>
                                <li><a href="../classes/Spinor3.html">Spinor3</a></li>
                                <li><a href="../classes/StringIUnknownMap.html">StringIUnknownMap</a></li>
                                <li><a href="../classes/StringIUnknownMap&lt;V extends IUnknown&gt;.html">StringIUnknownMap&lt;V extends IUnknown&gt;</a></li>
                                <li><a href="../classes/SurfaceGeometry.html">SurfaceGeometry</a></li>
                                <li><a href="../classes/Symbolic.html">Symbolic</a></li>
                                <li><a href="../classes/TetrahedronGeometry.html">TetrahedronGeometry</a></li>
                                <li><a href="../classes/UniformLocation.html">UniformLocation</a></li>
                                <li><a href="../classes/Unit.html">Unit</a></li>
                                <li><a href="../classes/Vector1.html">Vector1</a></li>
                                <li><a href="../classes/Vector2.html">Vector2</a></li>
                                <li><a href="../classes/Vector3.html">Vector3</a></li>
                                <li><a href="../classes/Vector3Uniform.html">Vector3Uniform</a></li>
                                <li><a href="../classes/Vector4.html">Vector4</a></li>
                                <li><a href="../classes/VectorN.html">VectorN</a></li>
                                <li><a href="../classes/VectorN&lt;T&gt;.html">VectorN&lt;T&gt;</a></li>
                                <li><a href="../classes/VersionLogger.html">VersionLogger</a></li>
                                <li><a href="../classes/VertexAttributeMap.html">VertexAttributeMap</a></li>
                                <li><a href="../classes/View.html">View</a></li>
                                <li><a href="../classes/VortexGeometry.html">VortexGeometry</a></li>
                                <li><a href="../classes/WebGLClear.html">WebGLClear</a></li>
                                <li><a href="../classes/WebGLClearColor.html">WebGLClearColor</a></li>
                                <li><a href="../classes/WebGLEnable.html">WebGLEnable</a></li>
                                <li><a href="../classes/WindowAnimationRunner.html">WindowAnimationRunner</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/EIGHT.html">EIGHT</a></li>
                                <li><a href="../modules/geometries.html">geometries</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/davinci-eight/slideshow/Animator.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import Delay = require(&#x27;../slideshow/animations/Delay&#x27;)
import IAnimation = require(&#x27;../slideshow/IAnimation&#x27;)
import IAnimationClock = require(&#x27;../slideshow/IAnimationClock&#x27;)
import IProperties = require(&#x27;../slideshow/IProperties&#x27;)
import IExchange = require(&#x27;../slideshow/IExchange&#x27;)
import IAnimateOptions = require(&#x27;../slideshow/IAnimateOptions&#x27;)
import mustBeNumber = require(&#x27;../checks/mustBeNumber&#x27;)
import Shareable = require(&#x27;../utils/Shareable&#x27;)
import StringIUnknownMap = require(&#x27;../utils/StringIUnknownMap&#x27;)
import IUnknown = require(&#x27;../core/IUnknown&#x27;)
import IUnknownArray = require(&#x27;../utils/IUnknownArray&#x27;)

class Clock implements IAnimationClock {
  public now: number = 1;
  constructor() {

  }
  update(speed: number): void {
    this.now += speed;
  }
}

class Animator extends Shareable {
  private drivers: IUnknownArray&lt;IProperties&gt;;
  private mirrors: StringIUnknownMap&lt;AnimatedMirror&gt;;
  private _clock = new Clock();
  constructor() {
    super(&#x27;Animator&#x27;)

    this.drivers = new IUnknownArray&lt;IProperties&gt;([], &#x27;Animator&#x27;)
    this.mirrors = new StringIUnknownMap&lt;AnimatedMirror&gt;(&#x27;Animator&#x27;)
  }
  protected destructor(): void {
    this.drivers.release()
    this.drivers = void 0
    this.mirrors.release()
    this.mirrors = void 0

    super.destructor()
  }
  get clock(): IAnimationClock {
    return this._clock
  }
  /**
   * Attach animator to an object.
   */
  attach(object: IProperties) {

    if (!this.mirrors.exists(object.uuid)) {
      var mirror = new AnimatedMirror();
      this.mirrors.put(object.uuid, mirror);
      mirror.release();
    }
    else {
      // Do nothing, object is already known.
    }

    // FIXME: This seems crude.
    // Override set method to abort running animations.
    /*
    var set = object.set;
    object.set = function (data: IExchange, ignore: boolean) {

      if (!ignore) {
        // Argument parsing
        if (object === undefined || object === null) {
          return;
        }
        else {
          // Stop all animations on the given keys
          animator.stop(this, data);
        }
      }

      // Pass through to Animated
      set.call(this, data);
    }
    */
    // Prepare animation queue.
  }

  /**
   * Hurry all animations on an object by speeding by a factor.
   */
  hurry(object: IProperties, attributes?: IExchange, factor: number = 4) {
    // Reduce
    var mirror = this.mirrors.get(object.uuid)
    if (mirror) {
      var queues = mirror.queuesXYZ
      try {
        var keys: string[] = attributes ? Object.keys(attributes) : queues.keys
        keys.forEach(function(key) {
          var queue = queues.get(key)
          queue.forEach(function(animation) {
            animation.hurry(factor)
          })
          queue.release()
        })
      }
      finally {
        queues.release()
      }
      mirror.release()
    }
  }

  /**
   * Stop all animations on an object.
   * @method stop
   * @param object {Animated}
   * @param attributes {IExchange}
   */
  stop(object: IProperties, attributes: IExchange) {
    var animator = this

    var mirror = this.mirrors.get(object.uuid)
    if (mirror) {
      var queues = mirror.queuesXYZ
      var keys = attributes ? Object.keys(attributes) : queues.keys
      keys.forEach(function(key) {
        var queue = queues.get(key)
        while(queue) {
          animator.dequeue(object, key, true)
          queue.release()
          queue = queues.get(key)
        }
      })
      queues.release()
      mirror.release()
    }
  }

  /**
   * Animate a set of attributes on an object.
   * @method animate
   * @param object {Animated} The object to be animated
   * @param animation {[name: string]:IAnimation} The animations to be applied by property name.
   * @param options [IAnimateOptions] determine how the attributes will be animated.
   */
  animate(object: IProperties, animations: { [name: string]: IAnimation }, options: IAnimateOptions = {}) {
    var animator = this
    var clock = this.clock

    // Ensure that the object has been initialized by having a queue and animations count.
    this.attach(object)

    var mirror = this.mirrors.get(object.uuid)
    try {
      var queues = mirror.queuesXYZ
      try {
        Object.keys(animations).forEach(function(key: string) {

          // If necessary, init queue for the current key.
          if (!queues.exists(key)) {
            let emptyArray = new IUnknownArray&lt;IAnimation&gt;([],&#x27;Animator.animate()&#x27;)
            queues.put(key, emptyArray)
            emptyArray.release()
          }

          var queue = queues.get(key)
          try {
            // Queue delay
            if (options.delay) {
              let delay = new Delay(clock, object, key, options.delay)
              queue.push(delay)
              delay.release()

              if (mirror.animations++ === 0) {
                animator.drivers.push(object);
              }
            }
            // Queue new animation
            queue.push(animations[key])

            // Queue hold
            if (options.hold) {
              let hold = new Delay(clock, object, key, options.hold);
              queue.push(hold)
              hold.release()

              if (mirror.animations++ === 0) {
                animator.drivers.push(object);
              }
            }

            // Keep track of animating objects
            if (mirror.animations++ === 0) {
              animator.drivers.push(object);
            }
          }
          finally {
            queue.release()
          }
        })
      }
      finally {
        queues.release()
      }
    }
    finally {
      mirror.release()
    }
  }

  /**
   * Remove current animation on an object attribute.
   */
  dequeue(object: IProperties, key: string, apply: boolean = false) {

    var mirror = this.mirrors.get(object.uuid)
    try {
      var queues = mirror.queuesXYZ
      try {
        var queue = queues.get(key)
        if (queue) {
          try {
            // Remove from front of queue.
            var animation = queue.shift()
            try {
              if (queue.length == 0) {
                  queues.remove(key)
              }

              // Apply animation instantly
              if (apply) {
                animation.skip();
              }

              // Keep track of animating objects
              if (--mirror.animations === 0) {
                this.drivers.splice(this.drivers.indexOf(object), 1).release()
              }
            }
            finally {
              animation.release()
            }
          }
          finally {
            queue.release()
          }
        }
      }
      finally {
        queues.release()
      }
    }
    finally {
      mirror.release()
    }
  }

  /**
   * Update all currently running animations.
   * Essentially calls &#x60;apply&#x60; on each IAnimation in the queues of active objects.
   * @method update
   * @param speed {number} Advances the static Animator.now property.
   */
  update(speed: number): void {
    var animator = this

    this._clock.update(speed)

    // Make a shallow copy of the currently active Animated objects.
    var active: IUnknownArray&lt;IProperties&gt; = this.drivers.slice()
    try {
      active.forEach(function(object: IProperties) {

        // Used to make queued animations match up at sub-frame times.
        var offset = 0

        function advance(animations: IUnknownArray&lt;IAnimation&gt;, key: string) {
          // The dequeue method of the animator could perform the
          // final death &#x60;release&#x60; of the animations. We must make sure
          // that we aren&#x27;t left holding a zombie.
          animations.addRef()
          try {
            // Write out animated attribute.
            var animation = animations.get(0);
            try {
              animation.apply(offset || 0);

              // Remove completed animations.
              if (animation.done()) {
                offset = animation.extra();
                animator.dequeue(object, key);

                // Recurse into next animation.
                if (animations.length &gt; 0) {
                  advance.call(animator, animations, key);
                }
              }
            }
            finally {
              animation.release()
            }
          }
          finally {
            animations.release()
          }
        }

        var mirror = animator.mirrors.get(object.uuid)
        try {
          var queues = mirror.queuesXYZ
          try {
            queues.forEach(function(key, animations) {
              advance(animations, key)
            })
          }
          finally {
            queues.release()
          }
        }
        finally {
          mirror.release()
        }
      })
    }
    finally {
      active.release()
    }
  }
}

export = Animator

// FIXME: Encapsulation make safer and less ref count issues.
class AnimatedMirror extends Shareable {
  private _queues: StringIUnknownMap&lt;IUnknownArray&lt;IAnimation&gt;&gt;;
  public animations: number;
  /**
   * The super-symmetric partner of an IProperties adapter.
   * This class keeps track of animation state.
   * @class AnimatedMirror
   * @constructor
   */
  constructor() {
    super(&#x27;AnimatedMirror&#x27;)
    this._queues = new StringIUnknownMap&lt;IUnknownArray&lt;IAnimation&gt;&gt;(&#x27;AnimatedMirror&#x27;)
    this.animations = 0
  }
  protected destructor(): void {
    this._queues.release()
    this._queues = void 0
    super.destructor()
  }
  // FIXME: Methinks this is leaking an animation.
  // If we had pUnkOuter, would we know?
  get queuesXYZ() {
    this._queues.addRef()
    return this._queues
  }
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
