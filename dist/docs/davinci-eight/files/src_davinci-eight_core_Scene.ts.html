<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/davinci-eight/core/Scene.ts - davinci-eight</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="davinci-eight" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.192.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AbstractMatrix.html">AbstractMatrix</a></li>
                                <li><a href="../classes/AmbientLight.html">AmbientLight</a></li>
                                <li><a href="../classes/Arrow.html">Arrow</a></li>
                                <li><a href="../classes/ArrowGeometry.html">ArrowGeometry</a></li>
                                <li><a href="../classes/AttribLocation.html">AttribLocation</a></li>
                                <li><a href="../classes/AttribMetaInfo.html">AttribMetaInfo</a></li>
                                <li><a href="../classes/Attribute.html">Attribute</a></li>
                                <li><a href="../classes/BlendFactor.html">BlendFactor</a></li>
                                <li><a href="../classes/Box.html">Box</a></li>
                                <li><a href="../classes/BoxGeometry.html">BoxGeometry</a></li>
                                <li><a href="../classes/CameraControls.html">CameraControls</a></li>
                                <li><a href="../classes/Capability.html">Capability</a></li>
                                <li><a href="../classes/CC.html">CC</a></li>
                                <li><a href="../classes/Color.html">Color</a></li>
                                <li><a href="../classes/ColorFacet.html">ColorFacet</a></li>
                                <li><a href="../classes/ColorRGB.html">ColorRGB</a></li>
                                <li><a href="../classes/ColorRGBA.html">ColorRGBA</a></li>
                                <li><a href="../classes/ContextAttributesLogger.html">ContextAttributesLogger</a></li>
                                <li><a href="../classes/createView.html">createView</a></li>
                                <li><a href="../classes/CuboidPrimitivesBuilder.html">CuboidPrimitivesBuilder</a></li>
                                <li><a href="../classes/Cylinder.html">Cylinder</a></li>
                                <li><a href="../classes/CylinderGeometry.html">CylinderGeometry</a></li>
                                <li><a href="../classes/Dimensions.html">Dimensions</a></li>
                                <li><a href="../classes/DirectionalLight.html">DirectionalLight</a></li>
                                <li><a href="../classes/Drawable.html">Drawable</a></li>
                                <li><a href="../classes/DrawMode.html">DrawMode</a></li>
                                <li><a href="../classes/EIGHTLogger.html">EIGHTLogger</a></li>
                                <li><a href="../classes/Facet.html">Facet</a></li>
                                <li><a href="../classes/FacetVisitor.html">FacetVisitor</a></li>
                                <li><a href="../classes/Frustum.html">Frustum</a></li>
                                <li><a href="../classes/G1.html">G1</a></li>
                                <li><a href="../classes/G2.html">G2</a></li>
                                <li><a href="../classes/G2m.html">G2m</a></li>
                                <li><a href="../classes/G3.html">G3</a></li>
                                <li><a href="../classes/G3m.html">G3m</a></li>
                                <li><a href="../classes/GeometricE2.html">GeometricE2</a></li>
                                <li><a href="../classes/GeometricE3.html">GeometricE3</a></li>
                                <li><a href="../classes/Geometry.html">Geometry</a></li>
                                <li><a href="../classes/GeometryContainer.html">GeometryContainer</a></li>
                                <li><a href="../classes/GeometryElements.html">GeometryElements</a></li>
                                <li><a href="../classes/GeometryPrimitive.html">GeometryPrimitive</a></li>
                                <li><a href="../classes/GraphicsProgramSymbols.html">GraphicsProgramSymbols</a></li>
                                <li><a href="../classes/HTMLScriptsMaterial.html">HTMLScriptsMaterial</a></li>
                                <li><a href="../classes/IContextConsumer.html">IContextConsumer</a></li>
                                <li><a href="../classes/IContextListener.html">IContextListener</a></li>
                                <li><a href="../classes/IContextProgramConsumer.html">IContextProgramConsumer</a></li>
                                <li><a href="../classes/IContextProvider.html">IContextProvider</a></li>
                                <li><a href="../classes/IUnknown.html">IUnknown</a></li>
                                <li><a href="../classes/LineMaterial.html">LineMaterial</a></li>
                                <li><a href="../classes/Material.html">Material</a></li>
                                <li><a href="../classes/Matrix2.html">Matrix2</a></li>
                                <li><a href="../classes/Matrix3.html">Matrix3</a></li>
                                <li><a href="../classes/Matrix4.html">Matrix4</a></li>
                                <li><a href="../classes/Mesh.html">Mesh</a></li>
                                <li><a href="../classes/MeshMaterial.html">MeshMaterial</a></li>
                                <li><a href="../classes/MeshNormalMaterial.html">MeshNormalMaterial</a></li>
                                <li><a href="../classes/ModelE2.html">ModelE2</a></li>
                                <li><a href="../classes/ModelE3.html">ModelE3</a></li>
                                <li><a href="../classes/ModelFacet.html">ModelFacet</a></li>
                                <li><a href="../classes/MouseControls.html">MouseControls</a></li>
                                <li><a href="../classes/Mutable.html">Mutable</a></li>
                                <li><a href="../classes/NumberIUnknownMap.html">NumberIUnknownMap</a></li>
                                <li><a href="../classes/Perspective.html">Perspective</a></li>
                                <li><a href="../classes/PerspectiveCamera.html">PerspectiveCamera</a></li>
                                <li><a href="../classes/PointMaterial.html">PointMaterial</a></li>
                                <li><a href="../classes/PointSizeFacet.html">PointSizeFacet</a></li>
                                <li><a href="../classes/Primitive.html">Primitive</a></li>
                                <li><a href="../classes/PrimitiveBuffers.html">PrimitiveBuffers</a></li>
                                <li><a href="../classes/Pseudo.html">Pseudo</a></li>
                                <li><a href="../classes/QQ.html">QQ</a></li>
                                <li><a href="../classes/R3.html">R3</a></li>
                                <li><a href="../classes/ReflectionFacetE2.html">ReflectionFacetE2</a></li>
                                <li><a href="../classes/ReflectionFacetE3.html">ReflectionFacetE3</a></li>
                                <li><a href="../classes/RigidBody.html">RigidBody</a></li>
                                <li><a href="../classes/Scalar.html">Scalar</a></li>
                                <li><a href="../classes/Scene.html">Scene</a></li>
                                <li><a href="../classes/Shareable.html">Shareable</a></li>
                                <li><a href="../classes/ShareableArray.html">ShareableArray</a></li>
                                <li><a href="../classes/ShareableContextListener.html">ShareableContextListener</a></li>
                                <li><a href="../classes/ShareableWebGLBuffer.html">ShareableWebGLBuffer</a></li>
                                <li><a href="../classes/ShareableWebGLShader.html">ShareableWebGLShader</a></li>
                                <li><a href="../classes/ShareableWebGLTexture.html">ShareableWebGLTexture</a></li>
                                <li><a href="../classes/Sphere.html">Sphere</a></li>
                                <li><a href="../classes/SphereGeometry.html">SphereGeometry</a></li>
                                <li><a href="../classes/Spinor2.html">Spinor2</a></li>
                                <li><a href="../classes/Spinor3.html">Spinor3</a></li>
                                <li><a href="../classes/SpinorE1.html">SpinorE1</a></li>
                                <li><a href="../classes/SpinorE2.html">SpinorE2</a></li>
                                <li><a href="../classes/SpinorE3.html">SpinorE3</a></li>
                                <li><a href="../classes/SpinorE4.html">SpinorE4</a></li>
                                <li><a href="../classes/StringIUnknownMap.html">StringIUnknownMap</a></li>
                                <li><a href="../classes/Tetrahedron.html">Tetrahedron</a></li>
                                <li><a href="../classes/TetrahedronGeometry.html">TetrahedronGeometry</a></li>
                                <li><a href="../classes/Trail.html">Trail</a></li>
                                <li><a href="../classes/UniformLocation.html">UniformLocation</a></li>
                                <li><a href="../classes/UniformMetaInfo.html">UniformMetaInfo</a></li>
                                <li><a href="../classes/Unit.html">Unit</a></li>
                                <li><a href="../classes/Vector.html">Vector</a></li>
                                <li><a href="../classes/Vector1.html">Vector1</a></li>
                                <li><a href="../classes/Vector2.html">Vector2</a></li>
                                <li><a href="../classes/Vector3.html">Vector3</a></li>
                                <li><a href="../classes/Vector3Facet.html">Vector3Facet</a></li>
                                <li><a href="../classes/Vector4.html">Vector4</a></li>
                                <li><a href="../classes/VectorE0.html">VectorE0</a></li>
                                <li><a href="../classes/VectorE1.html">VectorE1</a></li>
                                <li><a href="../classes/VectorE2.html">VectorE2</a></li>
                                <li><a href="../classes/VectorE3.html">VectorE3</a></li>
                                <li><a href="../classes/VectorE4.html">VectorE4</a></li>
                                <li><a href="../classes/VectorN.html">VectorN</a></li>
                                <li><a href="../classes/VersionLogger.html">VersionLogger</a></li>
                                <li><a href="../classes/View.html">View</a></li>
                                <li><a href="../classes/VisualBody.html">VisualBody</a></li>
                                <li><a href="../classes/WebGLBlendFunc.html">WebGLBlendFunc</a></li>
                                <li><a href="../classes/WebGLClearColor.html">WebGLClearColor</a></li>
                                <li><a href="../classes/WebGLDisable.html">WebGLDisable</a></li>
                                <li><a href="../classes/WebGLEnable.html">WebGLEnable</a></li>
                                <li><a href="../classes/WebGLRenderer.html">WebGLRenderer</a></li>
                                <li><a href="../classes/World.html">World</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/controls.html">controls</a></li>
                                <li><a href="../modules/core.html">core</a></li>
                                <li><a href="../modules/EIGHT.html">EIGHT</a></li>
                                <li><a href="../modules/facets.html">facets</a></li>
                                <li><a href="../modules/geometries.html">geometries</a></li>
                                <li><a href="../modules/materials.html">materials</a></li>
                                <li><a href="../modules/math.html">math</a></li>
                                <li><a href="../modules/visual.html">visual</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/davinci-eight/core/Scene.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import Facet from &#x27;../core/Facet&#x27;;
import IContextProvider from &#x27;../core/IContextProvider&#x27;;
import Drawable from &#x27;./Drawable&#x27;;
import ShareableArray from &#x27;../collections/ShareableArray&#x27;;
import mustBeObject from &#x27;../checks/mustBeObject&#x27;;
import Geometry from &#x27;./Geometry&#x27;;
import Shareable from &#x27;../core/Shareable&#x27;;
import ShareableContextListener from &#x27;../core/ShareableContextListener&#x27;;

/**
 * @module EIGHT
 * @submodule core
 */

/**
 * The parts of a scene are the smallest components that
 * are heuristically sorted in order to optimize rendering.
 */
class ScenePart extends Shareable {

    /**
     *
     */
    private _geometry: Geometry;

    /**
     * Keep track of the &#x27;parent&#x27; mesh.
     */
    private _mesh: Drawable;

    /**
     *
     */
    constructor(geometry: Geometry, mesh: Drawable) {
        super(&#x27;ScenePart&#x27;)
        this._geometry = geometry
        this._geometry.addRef()
        this._mesh = mesh
        this._mesh.addRef()
    }

    /**
     *
     */
    protected destructor(): void {
        this._geometry.release()
        this._mesh.release()
        this._geometry = void 0;
        this._mesh = void 0
        super.destructor()
    }

    /**
     *
     */
    draw(ambients: Facet[]) {
        if (this._mesh.visible) {
            const material = this._mesh.material

            material.use()

            if (ambients) {
                const aLength = ambients.length
                for (let a = 0; a &lt; aLength; a++) {
                    const ambient = ambients[a]
                    ambient.setUniforms(material)
                }
            }

            this._mesh.setUniforms();

            this._geometry.draw(material)
            material.release()
        }
    }
}

function partsFromMesh(mesh: Drawable): ShareableArray&lt;ScenePart&gt; {
    mustBeObject(&#x27;mesh&#x27;, mesh)
    const parts = new ShareableArray&lt;ScenePart&gt;()
    const geometry = mesh.geometry
    if (geometry.isLeaf()) {
      const scenePart = new ScenePart(geometry, mesh)
      parts.pushWeakRef(scenePart)
    }
    else {
      const iLen = geometry.partsLength
      for (let i = 0; i &lt; iLen; i++) {
          const geometryPart = geometry.getPart(i)
          // FIXME: This needs to go down to the leaves.
          const scenePart = new ScenePart(geometryPart, mesh)
          geometryPart.release()
          parts.pushWeakRef(scenePart)
      }
    }
    geometry.release()
    return parts
}

/**
 * @class Scene
 * @extends Shareable
 */
export default class Scene extends ShareableContextListener {

    private _meshes: ShareableArray&lt;Drawable&gt;;
    private _parts: ShareableArray&lt;ScenePart&gt;;

    // FIXME: Do I need the collection, or can I be fooled into thinking there is one monitor?
    /**
     * &lt;p&gt;
     * A &lt;code&gt;Scene&lt;/code&gt; is a collection of mesh instances arranged in some order.
     * The precise order is implementation defined.
     * The collection may be traversed for general processing using callback/visitor functions.
     * &lt;/p&gt;
     * @class Scene
     * @constructor
     */
    constructor() {
        super(&#x27;Scene&#x27;)
        this._meshes = new ShareableArray&lt;Drawable&gt;()
        this._parts = new ShareableArray&lt;ScenePart&gt;()
    }

    /**
     * @method destructor
     * @return {void}
     * @protected
     */
    protected destructor(): void {
        this.unsubscribe()
        this._meshes.release()
        this._parts.release()
        super.destructor()
    }

    /**
     * &lt;p&gt;
     * Adds the &lt;code&gt;mesh&lt;/code&gt; to this &lt;code&gt;Scene&lt;/code&gt;.
     * &lt;/p&gt;
     * @method add
     * @param mesh {Drawable}
     * @return {Void}
     * &lt;p&gt;
     * This method returns &lt;code&gt;undefined&lt;/code&gt;.
     * &lt;/p&gt;
     */
    add(mesh: Drawable): void {
        mustBeObject(&#x27;mesh&#x27;, mesh)
        this._meshes.push(mesh)

        // TODO: Control the ordering for optimization.
        const drawParts = partsFromMesh(mesh)
        const iLen = drawParts.length;
        for (let i = 0; i &lt; iLen; i++) {
            const part = drawParts.get(i)
            this._parts.push(part)
            part.release()
        }
        drawParts.release()
    }

    /**
     * @method contains
     * @param mesh {Drawable}
     * @return {boolean}
     */
    contains(mesh: Drawable): boolean {
        mustBeObject(&#x27;mesh&#x27;, mesh)
        return this._meshes.indexOf(mesh) &gt;= 0
    }

    /**
     * &lt;p&gt;
     * Traverses the collection of scene parts drawing each one.
     * &lt;/p&gt;
     * @method draw
     * @param ambients {Facet[]}
     * @return {void}
     * @beta
     */
    draw(ambients: Facet[]): void {
        const parts = this._parts
        const iLen = parts.length
        for (let i = 0; i &lt; iLen; i++) {
            parts.getWeakRef(i).draw(ambients)
        }
    }

    /**
     * @method find
     * @param match {(mesh: Drawable) =&gt; boolean}
     * @return {ShareableArray}
     */
    find(match: (mesh: Drawable) =&gt; boolean): ShareableArray&lt;Drawable&gt; {
        return this._meshes.find(match)
    }

    /**
     * @method findOne
     * @param match {(mesh: Drawable) =&gt; boolean}
     * @return {Drawable}
     */
    findOne(match: (mesh: Drawable) =&gt; boolean): Drawable {
        return this._meshes.findOne(match)
    }

    /**
     * @method findOneByName
     * @param name {string}
     * @return {Drawable}
     */
    findOneByName(name: string): Drawable {
        return this.findOne(function(mesh) { return mesh.name === name })
    }

    /**
     * @method findByName
     * @param name {string}
     * @return {ShareableArray}
     */
    findByName(name: string): ShareableArray&lt;Drawable&gt; {
        return this.find(function(mesh) { return mesh.name === name })
    }

    /**
     * &lt;p&gt;
     * Removes the &lt;code&gt;mesh&lt;/code&gt; from this &lt;code&gt;Scene&lt;/code&gt;.
     * &lt;/p&gt;
     *
     * @method remove
     * @param mesh {Drawable}
     * @return {void}
     */
    remove(mesh: Drawable): void {
        // TODO: Remove the appropriate parts from the scene.
        mustBeObject(&#x27;mesh&#x27;, mesh)
        const index = this._meshes.indexOf(mesh)
        if (index &gt;= 0) {
            this._meshes.splice(index, 1).release()
        }
    }

    /**
     * @method contextFree
     * @param context {IContextProvider}
     * @return {void}
     */
    contextFree(context: IContextProvider): void {
        for (let i = 0; i &lt; this._meshes.length; i++) {
            const mesh = this._meshes.getWeakRef(i)
            mesh.contextFree(context)
        }
        super.contextFree(context)
    }

    /**
     * @method contextGain
     * @param context {IContextProvider}
     * @return {void}
     */
    contextGain(context: IContextProvider): void {
        for (let i = 0; i &lt; this._meshes.length; i++) {
            const mesh = this._meshes.getWeakRef(i)
            mesh.contextGain(context)
        }
        super.contextGain(context)
    }

    /**
     * @method contextLost
     * @return {void}
     */
    contextLost(): void {
        for (let i = 0; i &lt; this._meshes.length; i++) {
            const mesh = this._meshes.getWeakRef(i)
            mesh.contextLost()
        }
        super.contextLost()
    }
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
