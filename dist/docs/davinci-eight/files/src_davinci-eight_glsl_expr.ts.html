<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/davinci-eight/glsl/expr.ts - davinci-eight</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="davinci-eight" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.196.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AbstractMatrix.html">AbstractMatrix</a></li>
                                <li><a href="../classes/AmbientLight.html">AmbientLight</a></li>
                                <li><a href="../classes/Arrow.html">Arrow</a></li>
                                <li><a href="../classes/ArrowGeometry.html">ArrowGeometry</a></li>
                                <li><a href="../classes/AttribLocation.html">AttribLocation</a></li>
                                <li><a href="../classes/AttribMetaInfo.html">AttribMetaInfo</a></li>
                                <li><a href="../classes/Attribute.html">Attribute</a></li>
                                <li><a href="../classes/BlendFactor.html">BlendFactor</a></li>
                                <li><a href="../classes/Box.html">Box</a></li>
                                <li><a href="../classes/BoxGeometry.html">BoxGeometry</a></li>
                                <li><a href="../classes/CameraControls.html">CameraControls</a></li>
                                <li><a href="../classes/Capability.html">Capability</a></li>
                                <li><a href="../classes/CC.html">CC</a></li>
                                <li><a href="../classes/Color.html">Color</a></li>
                                <li><a href="../classes/ColorFacet.html">ColorFacet</a></li>
                                <li><a href="../classes/ColorRGB.html">ColorRGB</a></li>
                                <li><a href="../classes/ColorRGBA.html">ColorRGBA</a></li>
                                <li><a href="../classes/ContextAttributesLogger.html">ContextAttributesLogger</a></li>
                                <li><a href="../classes/createView.html">createView</a></li>
                                <li><a href="../classes/CuboidPrimitivesBuilder.html">CuboidPrimitivesBuilder</a></li>
                                <li><a href="../classes/Cylinder.html">Cylinder</a></li>
                                <li><a href="../classes/CylinderGeometry.html">CylinderGeometry</a></li>
                                <li><a href="../classes/Dimensions.html">Dimensions</a></li>
                                <li><a href="../classes/DirectionalLight.html">DirectionalLight</a></li>
                                <li><a href="../classes/Drawable.html">Drawable</a></li>
                                <li><a href="../classes/DrawMode.html">DrawMode</a></li>
                                <li><a href="../classes/EIGHTLogger.html">EIGHTLogger</a></li>
                                <li><a href="../classes/Facet.html">Facet</a></li>
                                <li><a href="../classes/FacetVisitor.html">FacetVisitor</a></li>
                                <li><a href="../classes/Frustum.html">Frustum</a></li>
                                <li><a href="../classes/G1.html">G1</a></li>
                                <li><a href="../classes/G2.html">G2</a></li>
                                <li><a href="../classes/G3.html">G3</a></li>
                                <li><a href="../classes/Geometric2.html">Geometric2</a></li>
                                <li><a href="../classes/Geometric3.html">Geometric3</a></li>
                                <li><a href="../classes/GeometricE2.html">GeometricE2</a></li>
                                <li><a href="../classes/GeometricE3.html">GeometricE3</a></li>
                                <li><a href="../classes/Geometry.html">Geometry</a></li>
                                <li><a href="../classes/GeometryBuffers.html">GeometryBuffers</a></li>
                                <li><a href="../classes/GeometryContainer.html">GeometryContainer</a></li>
                                <li><a href="../classes/GeometryPrimitive.html">GeometryPrimitive</a></li>
                                <li><a href="../classes/GraphicsProgramSymbols.html">GraphicsProgramSymbols</a></li>
                                <li><a href="../classes/HTMLScriptsMaterial.html">HTMLScriptsMaterial</a></li>
                                <li><a href="../classes/IContextConsumer.html">IContextConsumer</a></li>
                                <li><a href="../classes/IContextListener.html">IContextListener</a></li>
                                <li><a href="../classes/IContextProgramConsumer.html">IContextProgramConsumer</a></li>
                                <li><a href="../classes/IContextProvider.html">IContextProvider</a></li>
                                <li><a href="../classes/IUnknown.html">IUnknown</a></li>
                                <li><a href="../classes/LineMaterial.html">LineMaterial</a></li>
                                <li><a href="../classes/Material.html">Material</a></li>
                                <li><a href="../classes/Matrix2.html">Matrix2</a></li>
                                <li><a href="../classes/Matrix3.html">Matrix3</a></li>
                                <li><a href="../classes/Matrix4.html">Matrix4</a></li>
                                <li><a href="../classes/Mesh.html">Mesh</a></li>
                                <li><a href="../classes/MeshMaterial.html">MeshMaterial</a></li>
                                <li><a href="../classes/MeshNormalMaterial.html">MeshNormalMaterial</a></li>
                                <li><a href="../classes/ModelE2.html">ModelE2</a></li>
                                <li><a href="../classes/ModelE3.html">ModelE3</a></li>
                                <li><a href="../classes/ModelFacet.html">ModelFacet</a></li>
                                <li><a href="../classes/MouseControls.html">MouseControls</a></li>
                                <li><a href="../classes/Mutable.html">Mutable</a></li>
                                <li><a href="../classes/NumberIUnknownMap.html">NumberIUnknownMap</a></li>
                                <li><a href="../classes/Perspective.html">Perspective</a></li>
                                <li><a href="../classes/PerspectiveCamera.html">PerspectiveCamera</a></li>
                                <li><a href="../classes/PointMaterial.html">PointMaterial</a></li>
                                <li><a href="../classes/PointSizeFacet.html">PointSizeFacet</a></li>
                                <li><a href="../classes/Primitive.html">Primitive</a></li>
                                <li><a href="../classes/PrimitiveBuffers.html">PrimitiveBuffers</a></li>
                                <li><a href="../classes/Pseudo.html">Pseudo</a></li>
                                <li><a href="../classes/QQ.html">QQ</a></li>
                                <li><a href="../classes/R3.html">R3</a></li>
                                <li><a href="../classes/ReflectionFacetE2.html">ReflectionFacetE2</a></li>
                                <li><a href="../classes/ReflectionFacetE3.html">ReflectionFacetE3</a></li>
                                <li><a href="../classes/RigidBody.html">RigidBody</a></li>
                                <li><a href="../classes/Scalar.html">Scalar</a></li>
                                <li><a href="../classes/Scene.html">Scene</a></li>
                                <li><a href="../classes/Shareable.html">Shareable</a></li>
                                <li><a href="../classes/ShareableArray.html">ShareableArray</a></li>
                                <li><a href="../classes/ShareableContextListener.html">ShareableContextListener</a></li>
                                <li><a href="../classes/ShareableWebGLBuffer.html">ShareableWebGLBuffer</a></li>
                                <li><a href="../classes/ShareableWebGLShader.html">ShareableWebGLShader</a></li>
                                <li><a href="../classes/ShareableWebGLTexture.html">ShareableWebGLTexture</a></li>
                                <li><a href="../classes/Sphere.html">Sphere</a></li>
                                <li><a href="../classes/SphereGeometry.html">SphereGeometry</a></li>
                                <li><a href="../classes/Spinor2.html">Spinor2</a></li>
                                <li><a href="../classes/Spinor3.html">Spinor3</a></li>
                                <li><a href="../classes/SpinorE1.html">SpinorE1</a></li>
                                <li><a href="../classes/SpinorE2.html">SpinorE2</a></li>
                                <li><a href="../classes/SpinorE3.html">SpinorE3</a></li>
                                <li><a href="../classes/SpinorE4.html">SpinorE4</a></li>
                                <li><a href="../classes/StringIUnknownMap.html">StringIUnknownMap</a></li>
                                <li><a href="../classes/Tetrahedron.html">Tetrahedron</a></li>
                                <li><a href="../classes/TetrahedronGeometry.html">TetrahedronGeometry</a></li>
                                <li><a href="../classes/Trail.html">Trail</a></li>
                                <li><a href="../classes/TriangleStrip.html">TriangleStrip</a></li>
                                <li><a href="../classes/UniformLocation.html">UniformLocation</a></li>
                                <li><a href="../classes/UniformMetaInfo.html">UniformMetaInfo</a></li>
                                <li><a href="../classes/Unit.html">Unit</a></li>
                                <li><a href="../classes/Vector.html">Vector</a></li>
                                <li><a href="../classes/Vector1.html">Vector1</a></li>
                                <li><a href="../classes/Vector2.html">Vector2</a></li>
                                <li><a href="../classes/Vector3.html">Vector3</a></li>
                                <li><a href="../classes/Vector3Facet.html">Vector3Facet</a></li>
                                <li><a href="../classes/Vector4.html">Vector4</a></li>
                                <li><a href="../classes/VectorE0.html">VectorE0</a></li>
                                <li><a href="../classes/VectorE1.html">VectorE1</a></li>
                                <li><a href="../classes/VectorE2.html">VectorE2</a></li>
                                <li><a href="../classes/VectorE3.html">VectorE3</a></li>
                                <li><a href="../classes/VectorE4.html">VectorE4</a></li>
                                <li><a href="../classes/VectorN.html">VectorN</a></li>
                                <li><a href="../classes/VersionLogger.html">VersionLogger</a></li>
                                <li><a href="../classes/Vertex.html">Vertex</a></li>
                                <li><a href="../classes/VertexAttributeMap.html">VertexAttributeMap</a></li>
                                <li><a href="../classes/View.html">View</a></li>
                                <li><a href="../classes/VisualBody.html">VisualBody</a></li>
                                <li><a href="../classes/WebGLBlendFunc.html">WebGLBlendFunc</a></li>
                                <li><a href="../classes/WebGLClearColor.html">WebGLClearColor</a></li>
                                <li><a href="../classes/WebGLDisable.html">WebGLDisable</a></li>
                                <li><a href="../classes/WebGLEnable.html">WebGLEnable</a></li>
                                <li><a href="../classes/WebGLRenderer.html">WebGLRenderer</a></li>
                                <li><a href="../classes/World.html">World</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/controls.html">controls</a></li>
                                <li><a href="../modules/core.html">core</a></li>
                                <li><a href="../modules/EIGHT.html">EIGHT</a></li>
                                <li><a href="../modules/facets.html">facets</a></li>
                                <li><a href="../modules/geometries.html">geometries</a></li>
                                <li><a href="../modules/materials.html">materials</a></li>
                                <li><a href="../modules/math.html">math</a></li>
                                <li><a href="../modules/visual.html">visual</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/davinci-eight/glsl/expr.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import LeftDenotation from &#x27;./LeftDenotation&#x27;
import Node from &#x27;./Node&#x27;
import NullDenotation from &#x27;./NullDenotation&#x27;
import Symbol from &#x27;./Symbol&#x27;
import Token from &#x27;./Token&#x27;
//
// See javascript.crockford.com/tdop/tdop.html
//
// We assume that the source text has been transformed into an array of tokens.
//

var state: any;
/**
 * The current token.
 */
var token: Token;
var tokens: Token[];
var idx: number;

function fail(message: string) {
    return function() { return state.unexpected(message) }
}

/**
 * The prototype for all other symbols. Its method will usually be overridden.
 */
let original_symbol = {
    nud: function() {
        return this.children &amp;&amp; this.children.length ? this : fail(&#x27;unexpected&#x27;)()
    },
    led: fail(&#x27;missing operator&#x27;)
}

let symbol_table: { [id: string]: Symbol } = {};

let itself: NullDenotation = function() {
    return this
}

/**
 * A function that makes symbols and looks them up in a cache.
 * @param id Identifier
 * @param bp Binding Power. Optional. Defaults to zero.
 */
function symbol(id: string, bp?: number) {
    var sym: Symbol = symbol_table[id];
    bp = bp || 0
    if (sym) {
        if (bp &gt; sym.lbp) {
            sym.lbp = bp
        }
    }
    else {
        sym = Object.create(original_symbol)
        sym.id = id
        sym.lbp = bp
        symbol_table[id] = sym
    }
    return sym
}

function infix(id: string, bp: number, led?: LeftDenotation): void {
    var sym: Symbol = symbol(id, bp)
    sym.led = led || function(left) {
        this.children = [left, expression(bp)]
        this.type = &#x27;binary&#x27;
        return this
    }
}

function infixr(id: string, bp: number, led?: LeftDenotation): Symbol {
    var sym = symbol(id, bp)
    sym.led = led || function(left) {
        this.children = [left, expression(bp - 1)]
        this.type = &#x27;binary&#x27;
        return this
    }
    return sym
}

function prefix(id: string, nud?: NullDenotation): Symbol {
    var sym = symbol(id)
    sym.nud = nud || function() {
        this.children = [expression(70)]
        this.type = &#x27;unary&#x27;
        return this
    }
    return sym
}

function suffix(id: string): void {
    var sym = symbol(id, 150)
    sym.led = function(left) {
        this.children = [left]
        this.type = &#x27;suffix&#x27;
        return this
    }
}

function assignment(id: string): Symbol {
    return infixr(id, 10, function(left) {
        this.children = [left, expression(9)]
        this.assignment = true
        this.type = &#x27;assign&#x27;
        return this
    })
}

// parentheses included to avoid collisions with user-defined tokens.
symbol(&#x27;(ident)&#x27;).nud = itself
symbol(&#x27;(keyword)&#x27;).nud = itself
symbol(&#x27;(builtin)&#x27;).nud = itself
symbol(&#x27;(literal)&#x27;).nud = itself
symbol(&#x27;(end)&#x27;);  // Indicates the end of the token stream.

symbol(&#x27;:&#x27;)
symbol(&#x27;;&#x27;)
symbol(&#x27;,&#x27;)
symbol(&#x27;)&#x27;)
symbol(&#x27;]&#x27;)
symbol(&#x27;}&#x27;)

infixr(&#x27;&amp;&amp;&#x27;, 30)
infixr(&#x27;||&#x27;, 30)
infix(&#x27;|&#x27;, 43)
infix(&#x27;^&#x27;, 44)
infix(&#x27;&amp;&#x27;, 45)
infix(&#x27;==&#x27;, 46)
infix(&#x27;!=&#x27;, 46)
infix(&#x27;&lt;&#x27;, 47)
infix(&#x27;&lt;=&#x27;, 47)
infix(&#x27;&gt;&#x27;, 47)
infix(&#x27;&gt;=&#x27;, 47)
infix(&#x27;&gt;&gt;&#x27;, 48)
infix(&#x27;&lt;&lt;&#x27;, 48)
infix(&#x27;+&#x27;, 50)
infix(&#x27;-&#x27;, 50)
infix(&#x27;*&#x27;, 60)
infix(&#x27;/&#x27;, 60)
infix(&#x27;%&#x27;, 60)
infix(&#x27;?&#x27;, 20, function(left: Symbol) {
    this.children = [left, expression(0), (advance(&#x27;:&#x27;), expression(0))]; // original.
    //this.children = [];
    //this.children.push(left);
    //this.children.push(expression(0));
    //advance(&#x27;:&#x27;);
    //this.children.push(expression(0));
    this.type = &#x27;ternary&#x27;
    return this
})
infix(&#x27;.&#x27;, 80, function(left) {
    token.type = &#x27;literal&#x27;
    state.fake(token)
    this.children = [left, token]
    advance()
    return this
})
infix(&#x27;[&#x27;, 80, function(left) {
    this.children = [left, expression(0)]
    this.type = &#x27;binary&#x27;
    advance(&#x27;]&#x27;)
    return this
})
infix(&#x27;(&#x27;, 80, function(left) {
    this.children = [left]
    this.type = &#x27;call&#x27;

    if (token.data !== &#x27;)&#x27;) {
        while (1) {
            this.children.push(expression(0));
            if (token.data !== &#x27;,&#x27;) {
                break;
            }
            advance(&#x27;,&#x27;);
        }
    }
    advance(&#x27;)&#x27;)
    return this
})

prefix(&#x27;-&#x27;)
prefix(&#x27;+&#x27;)
prefix(&#x27;!&#x27;)
prefix(&#x27;~&#x27;)
prefix(&#x27;defined&#x27;)
prefix(&#x27;(&#x27;, function() {
    this.type = &#x27;group&#x27;
    this.children = [expression(0)]
    advance(&#x27;)&#x27;)
    return this
})
prefix(&#x27;++&#x27;)
prefix(&#x27;--&#x27;)
suffix(&#x27;++&#x27;)
suffix(&#x27;--&#x27;)

assignment(&#x27;=&#x27;)
assignment(&#x27;+=&#x27;)
assignment(&#x27;-=&#x27;)
assignment(&#x27;*=&#x27;)
assignment(&#x27;/=&#x27;)
assignment(&#x27;%=&#x27;)
assignment(&#x27;&amp;=&#x27;)
assignment(&#x27;|=&#x27;)
assignment(&#x27;^=&#x27;)
assignment(&#x27;&gt;&gt;=&#x27;)
assignment(&#x27;&lt;&lt;=&#x27;)

export default function expr(incoming_state: any, incoming_tokens?: Token[]): void {

    function emit(node: Node) {
        state.unshift(node, false)
        for (var i = 0, len = node.children.length; i &lt; len; ++i) {
            emit(node.children[i])
        }
        state.shift()
    }

    state = incoming_state
    tokens = incoming_tokens
    idx = 0
    var result: any

    if (!tokens.length) {
        return
    }

    advance()
    result = expression(0)
    result.parent = state[0]
    emit(result)

    if (idx &lt; tokens.length) {
        throw new Error(&#x27;did not use all tokens&#x27;)
    }

    result.parent.children = [result]
}

/**
 * The heart of top-down precedence parsing (Pratt).
 * @param rbp Right Binding Power.
 */
function expression(rbp: number): Symbol {
    var left: Symbol;
    var t: Token = token;

    advance();

    left = t.nud();
    while (rbp &lt; token.lbp) {
        t = token
        advance()
        left = t.led(left)
    }
    return left
}

/**
 * Make a new token from the next simple object in the array and assign to the token variable
 */
function advance(id?: string): Token {
    var next: Token;
    var value: string;
    var type: string;
    /**
     * Symbol obtained from the symbol lookup table.
     */
    var output: Symbol;

    if (id &amp;&amp; token.data !== id) {
        return state.unexpected(&#x27;expected &#x60;&#x27; + id + &#x27;&#x60;, got &#x60;&#x27; + token.data + &#x27;&#x60;&#x27;)
    }

    if (idx &gt;= tokens.length) {
        token = symbol_table[&#x27;(end)&#x27;]
        return
    }

    next = tokens[idx++]
    value = next.data
    type = next.type

    if (type === &#x27;ident&#x27;) {
        output = state.scope.find(value) || state.create_node()
        type = output.type
    }
    else if (type === &#x27;builtin&#x27;) {
        output = symbol_table[&#x27;(builtin)&#x27;]
    }
    else if (type === &#x27;keyword&#x27;) {
        output = symbol_table[&#x27;(keyword)&#x27;]
    }
    else if (type === &#x27;operator&#x27;) {
        output = symbol_table[value]
        if (!output) {
            return state.unexpected(&#x27;unknown operator &#x60;&#x27; + value + &#x27;&#x60;&#x27;)
        }
    }
    else if (type === &#x27;float&#x27; || type === &#x27;integer&#x27;) {
        type = &#x27;literal&#x27;
        output = symbol_table[&#x27;(literal)&#x27;]
    }
    else {
        return state.unexpected(&#x27;unexpected token.&#x27;)
    }

    if (output) {
        if (!output.nud) { output.nud = itself }
        if (!output.children) { output.children = [] }
    }

    // FIXME: This should be assigning to token?
    output = Object.create(output)
    output.token = next
    output.type = type
    if (!output.data) {
        output.data = value
    }

    // I don&#x27;t think the assignment is required.
    // It also may be effing up the type safety.
    return token = output
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
